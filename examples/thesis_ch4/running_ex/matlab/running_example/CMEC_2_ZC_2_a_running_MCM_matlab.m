% function [tout,X,MX,Y] = CMEC_2_ZC_2_a_running_MCM_matlab(t,theta,kappa) 
function varargout = CMEC_2_ZC_2_a_running_MCM_matlab(varargin) 

t = varargin{1};
theta = varargin{2};
if(nargin>=3)
    kappa=varargin{3};
   if(length(kappa)==0)
    kappa(1:54)=0;
   end
else
    kappa = zeros(1,54);
end
x0 = [];
% Initial conditions
    x0 = x0fun(theta,kappa);

% Simulation
options = odeset('Mass',@(t,x) MMat(t,x,theta,kappa),...
'MStateDependence','strong','RelTol',1e-8,'AbsTol',1e-8);
[tout,X] = ode15s(@(t,x) rhs(t,x,theta,kappa),t,x0,options);
Y = rhsO(t,X,theta,kappa);

% Assign output
varargout{1} = tout;
if nargout >= 2
varargout{2} = X;
end
if nargout >= 3
    % Overall moments of species
    varargout{3} = Y(:,1:27);
end
if nargout >= 4
    % Moments of output variables
    varargout{4} = Y(:,28:end);
end
if nargout >= 5
    error('Too many output arguments.');
end


%% RIGHT-HAND SIDE
function [dxdt] = rhs(t,x,theta,kappa) 

dxdt = [-theta(3)*x(1)*x(6);...
         theta(3)*x(1)*x(6);...
         -x(1)*(theta(1)*x(3) - theta(2)*x(4) + theta(3)*x(10));...
         x(1)*(theta(1)*x(3) - 2*theta(2)*x(4) + theta(2)*x(5) - theta(3)*x(13));...
         x(1)*(theta(2)*x(4) + theta(1)*x(6) - 2*theta(2)*x(5) - theta(3)*x(15));...
         -x(1)*(theta(1)*x(6) - theta(2)*x(5) + theta(3)*x(16));...
         x(1)*(theta(1)*x(3) + theta(2)*x(4) - 2*theta(1)*x(7) + 2*theta(2)*x(8));...
         -x(1)*(theta(1)*x(3) + theta(2)*x(4) - theta(1)*x(7) + theta(1)*x(8) + 2*theta(2)*x(8) - theta(2)*x(9) - theta(2)*x(11));...
         x(1)*(theta(2)*x(8) - theta(1)*x(9) + theta(1)*x(10) - 2*theta(2)*x(9) + theta(2)*x(12));...
         x(1)*(theta(2)*x(9) - 2*theta(1)*x(10) + theta(2)*x(13));...
         x(1)*(theta(1)*x(3) + 2*theta(2)*x(4) + theta(2)*x(5) + 2*theta(1)*x(8) - 4*theta(2)*x(11) + 2*theta(2)*x(12));...
         x(1)*(theta(1)*x(9) - theta(2)*x(5) - theta(2)*x(4) + theta(2)*x(11) + theta(1)*x(13) - 4*theta(2)*x(12) + theta(2)*x(14));...
         x(1)*(theta(1)*x(10) - theta(1)*x(13) + theta(2)*x(12) - 2*theta(2)*x(13) + theta(2)*x(15));...
         x(1)*(theta(2)*x(4) + theta(1)*x(6) + 2*theta(2)*x(5) + 2*theta(2)*x(12) + 2*theta(1)*x(15) - 4*theta(2)*x(14));...
         -x(1)*(theta(1)*x(6) + theta(2)*x(5) - theta(2)*x(13) + theta(1)*x(15) - theta(2)*x(14) - theta(1)*x(16) + 2*theta(2)*x(15));...
         x(1)*(theta(1)*x(6) + theta(2)*x(5) - 2*theta(1)*x(16) + 2*theta(2)*x(15));...
         theta(3)*x(1)*x(10) - theta(1)*x(2)*x(17) + theta(3)*x(1)*x(3)*x(6) - theta(3)*x(1)*x(6)*x(17);...
         x(2)*(theta(1)*x(17) - theta(1)*x(18)) + theta(3)*x(1)*x(13) + theta(3)*x(1)*x(4)*x(6) - theta(3)*x(1)*x(6)*x(18);...
         x(2)*(theta(1)*x(18) - theta(1)*x(19)) + theta(3)*x(1)*x(15) + theta(3)*x(1)*x(5)*x(6) - theta(3)*x(1)*x(6)*x(19);...
         theta(3)*x(1)*x(6)^2 + theta(3)*x(1)*x(16) + theta(1)*x(2)*x(19) - theta(3)*x(1)*x(6)*x(20);...
         x(2)*(theta(1)*x(17) - 2*theta(1)*x(21)) + theta(3)*x(1)*x(6)*x(7) - theta(3)*x(1)*x(6)*x(21) + theta(3)*x(1)*x(10)*(2*x(3) - 2*x(17)) + theta(3)*x(1)*x(6)*(x(3) - x(17))^2;...
         theta(3)*x(1)*x(6)*x(8) - x(2)*(theta(1)*x(17) - theta(1)*x(21) + 2*theta(1)*x(22)) - theta(3)*x(1)*x(6)*x(22) + theta(3)*x(1)*x(10)*(x(4) - x(18)) + theta(3)*x(1)*x(13)*(x(3) - x(17)) + theta(3)*x(1)*x(6)*(x(3) - x(17))*(x(4) - x(18));...
         x(2)*(theta(1)*x(22) - 2*theta(1)*x(23)) + theta(3)*x(1)*x(6)*x(9) - theta(3)*x(1)*x(6)*x(23) + theta(3)*x(1)*x(10)*(x(5) - x(19)) + theta(3)*x(1)*x(15)*(x(3) - x(17)) + theta(3)*x(1)*x(6)*(x(3) - x(17))*(x(5) - x(19));...
         x(2)*(theta(1)*x(23) - theta(1)*x(24)) + theta(3)*x(1)*x(6)*x(10) - theta(3)*x(1)*x(6)*x(24) + theta(3)*x(1)*x(10)*(x(6) - x(20)) + theta(3)*x(1)*x(16)*(x(3) - x(17)) + theta(3)*x(1)*x(6)*(x(3) - x(17))*(x(6) - x(20));...
         x(2)*(theta(1)*x(17) + theta(1)*x(18) + 2*theta(1)*x(22) - 2*theta(1)*x(25)) + theta(3)*x(1)*x(6)*x(11) - theta(3)*x(1)*x(6)*x(25) + theta(3)*x(1)*x(13)*(2*x(4) - 2*x(18)) + theta(3)*x(1)*x(6)*(x(4) - x(18))^2;...
         theta(3)*x(1)*x(6)*x(12) - x(2)*(theta(1)*x(18) - theta(1)*x(23) - theta(1)*x(25) + 2*theta(1)*x(26)) - theta(3)*x(1)*x(6)*x(26) + theta(3)*x(1)*x(13)*(x(5) - x(19)) + theta(3)*x(1)*x(15)*(x(4) - x(18)) + theta(3)*x(1)*x(6)*(x(4) - x(18))*(x(5) - x(19));...
         x(2)*(theta(1)*x(24) + theta(1)*x(26) - theta(1)*x(27)) + theta(3)*x(1)*x(6)*x(13) - theta(3)*x(1)*x(6)*x(27) + theta(3)*x(1)*x(16)*(x(4) - x(18)) + theta(3)*x(1)*x(13)*(x(6) - x(20)) + theta(3)*x(1)*x(6)*(x(4) - x(18))*(x(6) - x(20));...
         x(2)*(theta(1)*x(18) + theta(1)*x(19) + 2*theta(1)*x(26) - 2*theta(1)*x(28)) + theta(3)*x(1)*x(6)*x(14) - theta(3)*x(1)*x(6)*x(28) + theta(3)*x(1)*x(15)*(2*x(5) - 2*x(19)) + theta(3)*x(1)*x(6)*(x(5) - x(19))^2;...
         theta(3)*x(1)*x(6)*x(15) - x(2)*(theta(1)*x(19) - theta(1)*x(27) - theta(1)*x(28) + theta(1)*x(29)) - theta(3)*x(1)*x(6)*x(29) + theta(3)*x(1)*x(16)*(x(5) - x(19)) + theta(3)*x(1)*x(15)*(x(6) - x(20)) + theta(3)*x(1)*x(6)*(x(5) - x(19))*(x(6) - x(20));...
         x(2)*(theta(1)*x(19) + 2*theta(1)*x(29)) + theta(3)*x(1)*x(6)*x(16) - theta(3)*x(1)*x(6)*x(30) + theta(3)*x(1)*x(16)*(2*x(6) - 2*x(20)) + theta(3)*x(1)*x(6)*(x(6) - x(20))^2];

%% MASS MATRIX
function [M] = MMat(t,x,theta,kappa) 

M = spdiags([1;...
         1;...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2)],0,30,30);

%% OUTPUT MAP
function y = rhsO(t,x,theta,kappa) 

y = [x(:,1),...
         x(:,2),...
         x(:,1).*x(:,3) + x(:,2).*x(:,17),...
         x(:,1).*x(:,4) + x(:,2).*x(:,18),...
         x(:,1).*x(:,5) + x(:,2).*x(:,19),...
         x(:,1).*x(:,6) + x(:,2).*x(:,20),...
         x(:,1).*(x(:,1) - 1).^2 + x(:,1).^2.*x(:,2),...
         x(:,1).*x(:,2).*(x(:,1) + x(:,2) - 2),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)) + x(:,1).*(x(:,1) - 1).*(x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18)) + x(:,1).*(x(:,1) - 1).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18)),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19)) + x(:,1).*(x(:,1) - 1).*(x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19)),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20)) + x(:,1).*(x(:,1) - 1).*(x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20)),...
         x(:,2).*(x(:,2) - 1).^2 + x(:,1).*x(:,2).^2,...
         x(:,1).*x(:,2).*(x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)) + x(:,2).*(x(:,2) - 1).*(x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18)) + x(:,2).*(x(:,2) - 1).*(x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18)),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19)) + x(:,2).*(x(:,2) - 1).*(x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19)),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20)) + x(:,2).*(x(:,2) - 1).*(x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20)),...
         x(:,1).*(x(:,7) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)).^2) + x(:,2).*(x(:,21) + (x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)).^2),...
         x(:,1).*(x(:,8) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18))) + x(:,2).*(x(:,22) + (x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)).*(x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18))),...
         x(:,1).*(x(:,9) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)).*(x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19))) + x(:,2).*(x(:,23) + (x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)).*(x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19))),...
         x(:,1).*(x(:,10) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)).*(x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20))) + x(:,2).*(x(:,24) + (x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)).*(x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20))),...
         x(:,1).*(x(:,11) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18)).^2) + x(:,2).*(x(:,25) + (x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18)).^2),...
         x(:,1).*(x(:,12) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18)).*(x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19))) + x(:,2).*(x(:,26) + (x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18)).*(x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19))),...
         x(:,1).*(x(:,13) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18)).*(x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20))) + x(:,2).*(x(:,27) + (x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18)).*(x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20))),...
         x(:,1).*(x(:,14) + (x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19)).^2) + x(:,2).*(x(:,28) + (x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19)).^2),...
         x(:,1).*(x(:,15) + (x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19)).*(x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20))) + x(:,2).*(x(:,29) + (x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19)).*(x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20))),...
         x(:,1).*(x(:,16) + (x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20)).^2) + x(:,2).*(x(:,30) + (x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20)).^2),...
         x(:,1).*x(:,3) + x(:,2).*x(:,17),...
         x(:,1).*x(:,4) + x(:,2).*x(:,18),...
         x(:,1).*x(:,5) + x(:,2).*x(:,19),...
         x(:,1).*x(:,6) + x(:,2).*x(:,20),...
         x(:,1).*(x(:,7) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)).^2) + x(:,2).*(x(:,21) + (x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)).^2),...
         x(:,1).*(x(:,8) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18))) + x(:,2).*(x(:,22) + (x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)).*(x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18))),...
         x(:,1).*(x(:,9) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)).*(x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19))) + x(:,2).*(x(:,23) + (x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)).*(x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19))),...
         x(:,1).*(x(:,10) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,17)).*(x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20))) + x(:,2).*(x(:,24) + (x(:,1).*x(:,3) - x(:,17) + x(:,2).*x(:,17)).*(x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20))),...
         x(:,1).*(x(:,11) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18)).^2) + x(:,2).*(x(:,25) + (x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18)).^2),...
         x(:,1).*(x(:,12) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18)).*(x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19))) + x(:,2).*(x(:,26) + (x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18)).*(x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19))),...
         x(:,1).*(x(:,13) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,18)).*(x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20))) + x(:,2).*(x(:,27) + (x(:,1).*x(:,4) - x(:,18) + x(:,2).*x(:,18)).*(x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20))),...
         x(:,1).*(x(:,14) + (x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19)).^2) + x(:,2).*(x(:,28) + (x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19)).^2),...
         x(:,1).*(x(:,15) + (x(:,1).*x(:,5) - x(:,5) + x(:,2).*x(:,19)).*(x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20))) + x(:,2).*(x(:,29) + (x(:,1).*x(:,5) - x(:,19) + x(:,2).*x(:,19)).*(x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20))),...
         x(:,1).*(x(:,16) + (x(:,1).*x(:,6) - x(:,6) + x(:,2).*x(:,20)).^2) + x(:,2).*(x(:,30) + (x(:,1).*x(:,6) - x(:,20) + x(:,2).*x(:,20)).^2)];


%% INITIAL CONDITIONS FOR STATE
function x0 = x0fun(theta,kappa) 

x0 = [562949953365017/562949953421312;...
       1/10000000000;...
       kappa(3)*kappa(30);...
       kappa(4)*kappa(31) - theta(4)*(kappa(4) - 1);...
       kappa(5)*kappa(32);...
       kappa(6)*kappa(33);...
       kappa(18)*kappa(45);...
       kappa(19)*kappa(46);...
       kappa(20)*kappa(47);...
       kappa(21)*kappa(48);...
       kappa(22)*kappa(49);...
       kappa(23)*kappa(50);...
       kappa(24)*kappa(51);...
       kappa(25)*kappa(52);...
       kappa(26)*kappa(53);...
       kappa(27)*kappa(54);...
       kappa(3)*kappa(30);...
       kappa(4)*kappa(31) - theta(4)*(kappa(4) - 1);...
       kappa(5)*kappa(32);...
       kappa(6)*kappa(33);...
       kappa(18)*kappa(45);...
       kappa(19)*kappa(46);...
       kappa(20)*kappa(47);...
       kappa(21)*kappa(48);...
       kappa(22)*kappa(49);...
       kappa(23)*kappa(50);...
       kappa(24)*kappa(51);...
       kappa(25)*kappa(52);...
       kappa(26)*kappa(53);...
       kappa(27)*kappa(54)];


